# UserDetailsImpl.java Documentation

## Overview
`UserDetailsImpl.java` implements Spring Security's `UserDetails` interface, representing an authenticated user principal with their authorities. It acts as an adapter between the application's User entity and Spring Security's authentication system.

## Class Declaration
```java
@NoArgsConstructor
@Data
public class UserDetailsImpl implements UserDetails
```

### Annotations:
- **@NoArgsConstructor**: Lombok annotation generating no-args constructor
- **@Data**: Lombok annotation generating getters, setters, toString, equals, and hashCode

### Interface:
- **UserDetails**: Core Spring Security interface representing an authenticated user

## Class Members

```java
private static final long serialVersionUID = 1L;

private Long id;
private String username;
private String email;

@JsonIgnore
private String password;

private Collection<? extends GrantedAuthority> authorities;
```

### Field Descriptions:
- **serialVersionUID**: Version control for serialization
- **id**: User's unique identifier from database
- **username**: User's login name
- **email**: User's email address
- **password**: User's encrypted password (hidden from JSON)
- **authorities**: User's roles/permissions

## Constructors

### No-Args Constructor
Generated by Lombok's `@NoArgsConstructor`

### All-Args Constructor
```java
public UserDetailsImpl(Long id, String username, String email, String password,
                      Collection<? extends GrantedAuthority> authorities)
```

**Parameters**:
- `Long id`: User ID
- `String username`: Username
- `String email`: Email address
- `String password`: Encrypted password
- `Collection<? extends GrantedAuthority> authorities`: User authorities

**Usage**: Called by the static `build()` method

## Static Factory Method: build

```java
public static UserDetailsImpl build(User user)
```

### Purpose:
Converts domain User entity to UserDetailsImpl

### Implementation:
```java
List<GrantedAuthority> authorities = user.getRoles().stream()
        .map(role -> new SimpleGrantedAuthority(role.getRoleName().name()))
        .collect(Collectors.toList());

return new UserDetailsImpl(
        user.getUserId(),
        user.getUserName(),
        user.getEmail(),
        user.getPassword(),
        authorities);
```

### Process:
1. **Extract Roles**: Gets roles from User entity
2. **Convert to Authorities**: Maps each role to SimpleGrantedAuthority
3. **Create Instance**: Constructs UserDetailsImpl with all data

### Authority Format:
- Input: `Role` with `AppRole.ROLE_USER`
- Output: `SimpleGrantedAuthority("ROLE_USER")`

## UserDetails Interface Methods

### 1. getAuthorities()
```java
@Override
public Collection<? extends GrantedAuthority> getAuthorities()
```
- **Returns**: User's granted authorities (roles)
- **Used By**: Spring Security for authorization decisions

### 2. getPassword()
```java
@Override
public String getPassword()
```
- **Returns**: User's encrypted password
- **Note**: Marked with `@JsonIgnore` to prevent exposure

### 3. getUsername()
```java
@Override
public String getUsername()
```
- **Returns**: Username for authentication
- **Primary Identifier**: Used throughout Spring Security

### 4. Account Status Methods
```java
@Override
public boolean isAccountNonExpired() {
    return true;
}

@Override
public boolean isAccountNonLocked() {
    return true;
}

@Override
public boolean isCredentialsNonExpired() {
    return true;
}

@Override
public boolean isEnabled() {
    return true;
}
```

**Current Implementation**: All return `true`
**Implication**: No account status checks implemented

## Additional Methods

### getId()
```java
public Long getId()
```
- Custom method (not from UserDetails)
- Returns user's database ID
- Useful for business logic

### getEmail()
```java
public String getEmail()
```
- Custom method (not from UserDetails)
- Returns user's email
- Used in responses and business logic

## Equals and HashCode

```java
@Override
public boolean equals(Object o) {
    if (this == o)
        return true;
    if (o == null || getClass() != o.getClass())
        return false;
    UserDetailsImpl user = (UserDetailsImpl) o;
    return Objects.equals(id, user.id);
}
```

### Equality Logic:
- Based solely on user ID
- Two UserDetailsImpl instances are equal if they have same ID
- Important for collections and caching

## Security Annotations

### @JsonIgnore on Password
```java
@JsonIgnore
private String password;
```

**Purpose**: Prevents password from being serialized to JSON
**Security**: Ensures passwords never exposed in API responses

## Usage in Authentication Flow

### 1. During Login:
```java
// In AuthService
UserDetailsImpl userDetails = (UserDetailsImpl) authentication.getPrincipal();
```

### 2. In JWT Token Generation:
```java
// In JwtUtils
public ResponseCookie generateJwtCookie(UserDetailsImpl userPrincipal) {
    String jwt = generateTokenFromUsername(userPrincipal.getUsername());
    // ...
}
```

### 3. In Controllers:
```java
@GetMapping("/me")
public ResponseEntity<?> getCurrentUser(@AuthenticationPrincipal UserDetailsImpl userDetails) {
    return ResponseEntity.ok(userDetails);
}
```

## Security Considerations

### Current Implementation Strengths:
✅ Password never exposed in JSON
✅ Immutable authorities collection
✅ Clear separation from domain entity

### Areas for Improvement:

1. **Account Status Implementation**:
```java
@Override
public boolean isEnabled() {
    return user.isActive(); // Add active field to User
}

@Override
public boolean isAccountNonLocked() {
    return !user.isLocked(); // Add locked field to User
}
```

2. **Additional Security Fields**:
```java
private Date lastLoginDate;
private int failedLoginAttempts;
private Date accountExpiryDate;
```

3. **Role Hierarchy Support**:
```java
// Admin has all permissions of User and Seller
if (authorities.contains(new SimpleGrantedAuthority("ROLE_ADMIN"))) {
    authorities.add(new SimpleGrantedAuthority("ROLE_USER"));
    authorities.add(new SimpleGrantedAuthority("ROLE_SELLER"));
}
```

## Testing

### Unit Test Example:
```java
@Test
public void testBuildUserDetails() {
    // Given
    User user = new User("testuser", "test@email.com", "password");
    Role userRole = new Role(AppRole.ROLE_USER);
    Role adminRole = new Role(AppRole.ROLE_ADMIN);
    user.setRoles(Set.of(userRole, adminRole));
    user.setUserId(1L);
    
    // When
    UserDetailsImpl userDetails = UserDetailsImpl.build(user);
    
    // Then
    assertEquals(1L, userDetails.getId());
    assertEquals("testuser", userDetails.getUsername());
    assertEquals("test@email.com", userDetails.getEmail());
    assertEquals(2, userDetails.getAuthorities().size());
    assertTrue(userDetails.getAuthorities().stream()
        .anyMatch(a -> a.getAuthority().equals("ROLE_USER")));
    assertTrue(userDetails.getAuthorities().stream()
        .anyMatch(a -> a.getAuthority().equals("ROLE_ADMIN")));
}
```

## Best Practices

### 1. Immutability:
Consider making UserDetailsImpl immutable:
```java
public final class UserDetailsImpl implements UserDetails {
    private final Long id;
    private final String username;
    // ... other final fields
}
```

### 2. Defensive Copying:
```java
public Collection<? extends GrantedAuthority> getAuthorities() {
    return new ArrayList<>(authorities);
}
```

### 3. Null Safety:
```java
public static UserDetailsImpl build(User user) {
    Objects.requireNonNull(user, "User cannot be null");
    // ... rest of implementation
}
```

## Common Issues

### Issue 1: Serialization Problems
**Problem**: UserDetailsImpl not serializable in session
**Solution**: Ensure all fields are serializable

### Issue 2: Concurrent Modification
**Problem**: Authorities modified after creation
**Solution**: Return unmodifiable collection

### Issue 3: Missing Authorities
**Problem**: Roles not properly converted
**Solution**: Ensure Role entity is properly loaded with User

## Performance Considerations

- **Lightweight Object**: Only essential fields
- **No Lazy Loading**: All data loaded upfront
- **Efficient Equality**: Based on ID only

## Related Components
- **User**: Domain entity source
- **Role**: Authority source
- **UserDetailsServiceImpl**: Creates instances
- **AuthTokenFilter**: Uses for authentication
- **JwtUtils**: Uses for token generation 